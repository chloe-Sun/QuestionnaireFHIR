<html lang="en">
<head>
    <link rel="stylesheet" href="css/style.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Main page</title>
</head>
<body>
    <div class = "app">
        <div class = "header">
            <h1>Smartphone Questionnaire App</h1>
        </div>
        <div class = "content">
            <figure class = "menu">
                <a href = "profile.html">
                    <img src = "./images/user.png">
                    <figcaption>User Profile</figcaption>
                </a>
            </figure>

            <figure class = "menu">
                <a href = "patient.html">
                    <img src = "./images/patientList.jpg">
                    <figcaption>Patient List</figcaption>
                </a>
            </figure>

            <figure class = "menu">
                <a href = "about.html">
                    <img src = "./images/about.jpg">
                    <figcaption>About</figcaption>
                </a>
            </figure>
        </div>
        
        <p class = "copyright">Copyright @ COMP3001-G6</p>
    </div>
</body>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script>
        FHIR.oauth2.ready().then(function(client) {

        client.patient.read().then(
            function(pt) {
                localStorage.setItem("patientInfo",JSON.stringify(pt, null, 4));
                console.log(pt);
            },
            function(error) {
                document.getElementById("patient").innerText = error.stack;
            }
        );

        client.user.read().then(
            function(ur) {
                localStorage.setItem("userInfo",JSON.stringify(ur,null,4));
                console.log(ur);
            },
            function(error) {
                console.log("get user info failed");
            }
        )

        const response = {
  "resourceType": "QuestionnaireResponse",
  "id": "gcs",
  "text": {
    "status": "generated",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><p><b>Generated Narrative with Details</b></p><p><b>id</b>: gcs</p><p><b>questionnaire</b>: <a>Questionnaire/gcs</a></p><p><b>status</b>: completed</p><p><b>subject</b>: <a>Peter James Chalmers</a></p><p><b>authored</b>: 11/12/2014 4:44:16 AM</p><p><b>source</b>: <a>Practitioner/f007</a></p><blockquote><p><b>item</b></p><p><b>linkId</b>: 1.1</p><h3>Answers</h3><table><tr><td>-</td><td><b>Value[x]</b></td></tr><tr><td>*</td><td>Confused (Details: LOINC code LA6560-2 = 'Confused', stated as 'Confused')</td></tr></table></blockquote><blockquote><p><b>item</b></p><p><b>linkId</b>: 1.2</p><h3>Answers</h3><table><tr><td>-</td><td><b>Value[x]</b></td></tr><tr><td>*</td><td>Localizing pain (Details: LOINC code LA6566-9 = 'Localizing pain', stated as 'Localizing pain')</td></tr></table></blockquote><blockquote><p><b>item</b></p><p><b>linkId</b>: 1.3</p><h3>Answers</h3><table><tr><td>-</td><td><b>Value[x]</b></td></tr><tr><td>*</td><td>Eyes open spontaneously (Details: LOINC code LA6556-0 = 'Eyes open spontaneously', stated as 'Eyes open spontaneously')</td></tr></table></blockquote></div>"
  },
//   "questionnaire": "Questionnaire/gcs",
  "status": "completed",
  "subject": {
    "reference": "Patient/" + client.patient.id,
    "display": "Peter James Chalmers"
  },
  "authored": "2014-12-11T04:44:16Z",
  "source": {
    "reference": "Practitioner/" + client.user.id
  },
  "item": [
    {
      "linkId": "1.1",
      "answer": [
        {
          "valueCoding": {
            "extension": [
              {
                "url": "http://hl7.org/fhir/StructureDefinition/ordinalValue",
                "valueDecimal": 4
              }
            ],
            "system": "http://loinc.org",
            "code": "LA6560-2",
            "display": "Confused"
          }
        }
      ]
    },
    {
      "linkId": "1.2",
      "answer": [
        {
          "valueCoding": {
            "extension": [
              {
                "url": "http://hl7.org/fhir/StructureDefinition/ordinalValue",
                "valueDecimal": 5
              }
            ],
            "system": "http://loinc.org",
            "code": "LA6566-9",
            "display": "Localizing pain"
          }
        }
      ]
    },
    {
      "linkId": "1.3",
      "answer": [
        {
          "valueCoding": {
            "extension": [
              {
                "url": "http://hl7.org/fhir/StructureDefinition/ordinalValue",
                "valueDecimal": 4
              }
            ],
            "system": "http://loinc.org",
            "code": "LA6556-0",
            "display": "Eyes open spontaneously"
          }
        }
      ]
    }
  ]
}

        const phq9 = {
  "resourceType": "Questionnaire",
  "id": "phq-9-questionnaire",
  "meta": {
    "profile": [
      "http://hl7.org/fhir/StructureDefinition/cqf-questionnaire"
    ]
  },
  "text": {
    "status": "generated",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">PHQ-9 Questionnaire with dynamic logic</div>"
  },
  "extension": [
    {
      "url": "http://hl7.org/fhir/StructureDefinition/cqf-library",
      "valueCanonical": "Library/phq-9-logic"
    }
  ],
  "identifier": [
    {
      "use": "official",
      "value": "phq-9"
    }
  ],
  "version": "1.0.0",
  "title": "Patient Health Questionnaire (PHQ-9)",
  "status": "draft",
  "subjectType": [
    "Patient"
  ],
  "code": [
    {
      "system": "http://loinc.org",
      "code": "44249-1",
      "display": "PHQ-9 quick depression assessment panel:-:Pt:^Patient:-:Report.PHQ-9"
    }
  ],
  "item": [
    {
      "linkId": "LittleInterest",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44250-9"
        }
      ],
      "text": "Little interest or pleasure in doing things",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "linkId": "FeelingDown",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44255-8"
        }
      ],
      "text": "Feeling down, depressed, or hopeless",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "linkId": "TroubleSleeping",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44259-0"
        }
      ],
      "text": "Trouble falling or staying asleep",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "linkId": "FeelingTired",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44254-1"
        }
      ],
      "text": "Feeling tired or having little energy",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "linkId": "BadAppetite",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44251-7"
        }
      ],
      "text": "Poor appetite or overeating",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "linkId": "FeelingBadAboutSelf",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44258-2"
        }
      ],
      "text": "Feeling bad about yourself - or that you are a failure or have let yourself or your family down",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "linkId": "TroubleConcentrating",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44252-5"
        }
      ],
      "text": "Trouble concentrating on things, such as reading the newspaper or watching television",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "linkId": "MovingSpeaking",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44253-3"
        }
      ],
      "text": "Moving or speaking so slowly that other people could have noticed. Or the opposite - being so fidgety or restless that you have been moving around a lot more than usual",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    },
    {
      "extension": [
        {
          "url": "http://hl7.org/fhir/StructureDefinition/cqf-expression",
          "valueExpression": {
            "language": "text/cql",
            "expression": "CalculateTotalScore"
          }
        }
      ],
      "linkId": "TotalScore",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44261-6"
        }
      ],
      "text": "Total score",
      "type": "integer",
      "required": true
    },
    {
      "linkId": "Difficulty",
      "code": [
        {
          "system": "http://loinc.org",
          "code": "44256-6"
        }
      ],
      "text": "If you checked off any problems, how difficult have these problems made it for you to do your work, take care of things at home, or get along with other people",
      "type": "choice",
      "required": true,
      "answerValueSet": "http://loinc.org/vs/LL358-3"
    }
  ]
}
        client.create(phq9);


        client.request("/QuestionnaireResponse?patient=" + client.patient.id, {
            resolveReferences: [ "QuestionnaireResponseReference" ],
            graph: true
        })
        

        .then(function(data) {
            localStorage.setItem("questionnaire", JSON.stringify(data));
            console.log(data)
            if (!data.entry || !data.entry.length) {
                localStorage.setItem("questionnaire", "No questionnaire found for the selected patient");
                // throw new Error("No questionnaire found for the selected patient");
            }
            return data.entry;
            
        });

        client.request("/Questionnaire?_id=phq-9-questionnaire", {
            resolveReferences: ["QuestionnaireReference"],
            graph: true
        })

        .then(function(data) {
            console.log(data)
        });

        }).catch(console.error);

        
    </script>
</html>
