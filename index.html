<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main page</title>
</head>
<body>


<script src=https://cdn.jsdelivr.net/npm/fhirclient@latest/build/fhir-client.js></script>
<script src=https://cdn.jsdelivr.net/npm/fhirclient@latest/build/fhir-client.min.js></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script>
var ret = $.Deferred();

function onError() {
  console.log('Loading error', arguments);
  ret.reject();
}

function onReady(smart)  {
    console.log('update');
  if (smart.hasOwnProperty('patient')) {
    var patient = smart.patient;
    var pt = patient.read();
    // var obv = smart.patient.api.fetchAll({
    //             type: 'Observation',
    //             query: {
    //               code: {
    //                 $or: ['http://loinc.org|8302-2', 'http://loinc.org|8462-4',
    //                       'http://loinc.org|8480-6', 'http://loinc.org|2085-9',
    //                       'http://loinc.org|2089-1', 'http://loinc.org|55284-4']
    //               }
    //             }
    //           });

    $.when(pt).fail(onError);

    $.when(pt).done(function(patient) {
      var gender = patient.gender;

      var fname = '';
      var lname = '';

      if (typeof patient.name[0] !== 'undefined') {
        fname = patient.name[0].given.join(' ');
        lname = patient.name[0].family.join(' ');
      }
      console.log(fname);
      console.log(lname);
    });

//       var height = byCodes('8302-2');
//       var systolicbp = getBloodPressureValue(byCodes('55284-4'),'8480-6');
//       var diastolicbp = getBloodPressureValue(byCodes('55284-4'),'8462-4');
//       var hdl = byCodes('2085-9');
//       var ldl = byCodes('2089-1');

//       var p = defaultPatient();
//       p.birthdate = patient.birthDate;
//       p.gender = gender;
//       p.fname = fname;
//       p.lname = lname;
//       p.height = getQuantityValueAndUnit(height[0]);

//       if (typeof systolicbp != 'undefined')  {
//         p.systolicbp = systolicbp;
//       }

//       if (typeof diastolicbp != 'undefined') {
//         p.diastolicbp = diastolicbp;
//       }

//       p.hdl = getQuantityValueAndUnit(hdl[0]);
//       p.ldl = getQuantityValueAndUnit(ldl[0]);

//       ret.resolve(p);
//     });
//   } else {
//     onError();
  }
}

FHIR.oauth2.ready(onReady, onError);
// return ret.promise();
</script>

</body>
</html>
